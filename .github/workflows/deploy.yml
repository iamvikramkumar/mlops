name: Deploy to KIND via DockerHub Image

on:
  workflow_run:
    workflows: ["Build and Push Docker Image to DockerHub"]
    types:
      - completed

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: self-hosted

    steps:
    - name: ✅ Print basic runner info (Debug)
      run: |
        echo "🖥️ Runner Info:"
        hostname
        date
        uname -a

    - name: 🐳 Check Docker & KIND (Debug)
      run: |
        docker ps
        kind get clusters || echo "❌ KIND cluster not found"
        kind get kubeconfig --name kind-demo-mlops || echo "❌ Failed to get kubeconfig"

    - name: Checkout Code
      uses: actions/checkout@v3

    - name: 🔍 Debug - Show project structure
      run: ls -R

    - name: 🧠 Set up KUBECONFIG for KIND
      run: |
        mkdir -p $HOME/.kube
        kind get kubeconfig --name kind-demo-mlops > $HOME/.kube/config

    - name: 🧠 Deploy using DockerHub image
      run: kubectl apply -f mlops-project/k8s-deploy.yml

    - name: ⏳ Wait for Deployment
      run: kubectl rollout status deployment/diabetes-api

    - name: 🔁 Port forward in background
      run: |
        nohup kubectl port-forward svc/diabetes-api-service 1111:80 --address=0.0.0.0 > port-forward.log 2>&1 &
        sleep 10

    - name: 🧪 Test FastAPI /docs
      run: |
        curl --fail http://localhost:1111/docs || (echo "❌ /docs failed" && exit 1)

    - name: 🔬 Test FastAPI /predict
      run: |
        curl -X POST http://localhost:1111/predict \
          -H "Content-Type: application/json" \
          -d '{"feature1": 1.2, "feature2": 0.3, "feature3": 5.1}' || echo "❌ /predict failed"
